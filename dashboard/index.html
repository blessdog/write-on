<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard — Write On</title>
<meta name="description" content="Your Write On account dashboard. View usage, manage subscription.">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0a0f;
    --bg-subtle: #0e0e16;
    --bg-card: #11111a;
    --bg-card-hover: #151522;
    --cyan: #3dffd8;
    --cyan-dim: #1a8a6e;
    --cyan-glow: rgba(61, 255, 216, 0.15);
    --text: #e0f0ec;
    --text-dim: #6a8a82;
    --text-muted: #3a5a52;
    --mono: 'Space Mono', 'SF Mono', 'Fira Code', monospace;
    --sans: 'Inter', -apple-system, system-ui, sans-serif;
    --border: rgba(61, 255, 216, 0.1);
    --border-bright: rgba(61, 255, 216, 0.25);
  }

  html {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    -webkit-font-smoothing: antialiased;
  }

  body {
    overflow-x: hidden;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ── Nav ── */
  .nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.2rem 2rem;
    max-width: 1100px;
    margin: 0 auto;
    width: 100%;
    border-bottom: 1px solid var(--border);
  }

  .nav-logo {
    font-family: var(--mono);
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text);
    text-decoration: none;
  }

  .nav-logo span {
    color: var(--cyan);
  }

  .nav-links {
    display: flex;
    align-items: center;
    gap: 1.8rem;
    list-style: none;
  }

  .nav-links a {
    font-family: var(--mono);
    font-size: 0.8rem;
    color: var(--text-dim);
    text-decoration: none;
    letter-spacing: 0.04em;
    transition: color 0.2s;
  }

  .nav-links a:hover {
    color: var(--cyan);
  }

  .nav-links a.active {
    color: var(--cyan);
  }

  .nav-user {
    font-family: var(--mono);
    font-size: 0.75rem;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .nav-user .user-dot {
    width: 8px;
    height: 8px;
    background: var(--cyan);
    border-radius: 50%;
    display: inline-block;
  }

  /* ── Dashboard Content ── */
  .dashboard {
    flex: 1;
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
    padding: 3rem 2rem;
  }

  .dashboard-header {
    margin-bottom: 2.5rem;
  }

  .dashboard-header h1 {
    font-family: var(--mono);
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.3rem;
  }

  .dashboard-header h1 span {
    color: var(--cyan);
  }

  .dashboard-header p {
    font-size: 0.9rem;
    color: var(--text-dim);
  }

  /* ── Loading State ── */
  .loading-state {
    text-align: center;
    padding: 4rem 2rem;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    margin: 0 auto 1rem;
    border: 2px solid var(--border);
    border-top-color: var(--cyan);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-state p {
    font-family: var(--mono);
    font-size: 0.8rem;
    color: var(--text-dim);
  }

  /* ── Cards ── */
  .cards-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 1.8rem;
    transition: border-color 0.2s;
  }

  .card:hover {
    border-color: var(--border-bright);
  }

  .card-label {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--text-dim);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 0.8rem;
  }

  .card-value {
    font-family: var(--mono);
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 0.2rem;
  }

  .card-value span {
    color: var(--cyan);
  }

  .card-detail {
    font-size: 0.78rem;
    color: var(--text-dim);
  }

  /* ── Plan Badge ── */
  .plan-badge {
    display: inline-block;
    font-family: var(--mono);
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.3em 0.8em;
    border-radius: 2px;
  }

  .plan-badge.free {
    color: var(--text-dim);
    background: rgba(106, 138, 130, 0.15);
    border: 1px solid rgba(106, 138, 130, 0.3);
  }

  .plan-badge.pro {
    color: var(--cyan);
    background: var(--cyan-glow);
    border: 1px solid rgba(61, 255, 216, 0.3);
  }

  .plan-badge.lifetime {
    color: var(--bg);
    background: var(--cyan);
    border: 1px solid var(--cyan);
  }

  /* ── Usage Bar ── */
  .usage-section {
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 1.8rem;
    margin-bottom: 1.5rem;
  }

  .usage-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .usage-header .card-label {
    margin-bottom: 0;
  }

  .usage-count {
    font-family: var(--mono);
    font-size: 0.85rem;
    color: var(--text);
  }

  .usage-count span {
    color: var(--cyan);
  }

  .usage-bar-track {
    width: 100%;
    height: 8px;
    background: var(--bg);
    border: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }

  .usage-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--cyan-dim), var(--cyan));
    transition: width 0.6s ease;
    position: relative;
  }

  .usage-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 20px;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3));
  }

  .usage-bar-fill.warning {
    background: linear-gradient(90deg, #ff9f43, #ff6b6b);
  }

  .usage-bar-fill.unlimited {
    width: 100% !important;
    background: linear-gradient(90deg, var(--cyan-dim) 0%, var(--cyan) 30%, var(--cyan-dim) 60%, var(--cyan) 100%);
    background-size: 200% 100%;
    animation: shimmer 3s ease-in-out infinite;
  }

  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  .usage-label {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--text-dim);
  }

  /* ── Actions ── */
  .actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }

  .btn {
    font-family: var(--mono);
    font-size: 0.8rem;
    font-weight: 700;
    padding: 0.75em 1.5em;
    border: 1px solid var(--cyan-dim);
    background: transparent;
    color: var(--cyan);
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 8px, 100% 100%, 8px 100%, 0 calc(100% - 8px));
  }

  .btn:hover {
    background: rgba(61, 255, 216, 0.08);
    border-color: var(--cyan);
  }

  .btn.primary {
    background: var(--cyan);
    color: var(--bg);
    border-color: var(--cyan);
  }

  .btn.primary:hover {
    background: #fff;
    box-shadow: 0 4px 30px var(--cyan-glow);
  }

  .btn.danger {
    border-color: rgba(255, 107, 107, 0.3);
    color: #ff6b6b;
  }

  .btn.danger:hover {
    background: rgba(255, 107, 107, 0.08);
    border-color: #ff6b6b;
  }

  .btn svg {
    width: 14px;
    height: 14px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
  }

  /* ── Privacy Notice ── */
  .privacy-notice {
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 1.5rem 1.8rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .privacy-notice svg {
    width: 20px;
    height: 20px;
    stroke: var(--cyan-dim);
    fill: none;
    stroke-width: 1.5;
    flex-shrink: 0;
    margin-top: 0.1rem;
  }

  .privacy-notice p {
    font-size: 0.82rem;
    color: var(--text-dim);
    line-height: 1.5;
  }

  .privacy-notice strong {
    color: var(--text);
    font-weight: 600;
  }

  /* ── Account Section ── */
  .section-divider {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text-muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin: 2.5rem 0 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border);
  }

  .account-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.8rem 0;
    border-bottom: 1px solid var(--border);
  }

  .account-row:last-child {
    border-bottom: none;
  }

  .account-row-label {
    font-family: var(--mono);
    font-size: 0.78rem;
    color: var(--text-dim);
  }

  .account-row-value {
    font-family: var(--mono);
    font-size: 0.78rem;
    color: var(--text);
  }

  /* ── Footer ── */
  .footer {
    padding: 2rem;
    text-align: center;
    border-top: 1px solid var(--border);
    margin-top: auto;
  }

  .footer p {
    font-size: 0.75rem;
    color: var(--text-dim);
  }

  /* ── Hidden ── */
  .hidden {
    display: none !important;
  }

  /* ── Responsive ── */
  @media (max-width: 600px) {
    .cards-grid {
      grid-template-columns: 1fr;
    }
    .nav {
      padding: 1rem 1.2rem;
    }
    .nav-links {
      gap: 1rem;
    }
    .nav-links a {
      font-size: 0.7rem;
    }
    .actions {
      flex-direction: column;
    }
    .btn {
      justify-content: center;
    }
    .account-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.2rem;
    }
  }
</style>
</head>
<body>

<!-- ── Nav ── -->
<nav class="nav">
  <a href="/" class="nav-logo">Write<span>On</span></a>
  <ul class="nav-links">
    <li><a href="/">Home</a></li>
    <li><a href="/pricing/">Pricing</a></li>
    <li><a href="/dashboard/" class="active">Dashboard</a></li>
  </ul>
</nav>

<!-- ── Loading State ── -->
<div class="dashboard" id="loadingState">
  <div class="loading-state">
    <div class="loading-spinner"></div>
    <p>Loading your dashboard...</p>
  </div>
</div>

<!-- ── Dashboard Content ── -->
<div class="dashboard hidden" id="dashboardContent">

  <!-- Header -->
  <div class="dashboard-header">
    <h1>Your <span>dashboard</span></h1>
    <p id="welcomeText">Manage your account and subscription.</p>
  </div>

  <!-- Stats Cards -->
  <div class="cards-grid">
    <div class="card">
      <div class="card-label">Current Plan</div>
      <div class="card-value" id="planName">Free</div>
      <div style="margin-top: 0.5rem;">
        <span class="plan-badge free" id="planBadge">FREE</span>
      </div>
    </div>
    <div class="card">
      <div class="card-label">Billing</div>
      <div class="card-value" id="billingAmount"><span>$</span>0</div>
      <div class="card-detail" id="billingDetail">No active subscription</div>
    </div>
  </div>

  <!-- Usage -->
  <div class="usage-section">
    <div class="usage-header">
      <div class="card-label">Usage This Month</div>
      <div class="usage-count" id="usageCount"><span>0</span> / 15 min</div>
    </div>
    <div class="usage-bar-track">
      <div class="usage-bar-fill" id="usageBar" style="width: 0%"></div>
    </div>
    <div class="usage-label">
      <span id="usageStart">Feb 1</span>
      <span id="usageEnd">Feb 28</span>
    </div>
  </div>

  <!-- Actions -->
  <div class="actions" id="actionsSection">
    <a href="/pricing/" class="btn primary" id="upgradeBtn">
      <svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      Upgrade Plan
    </a>
    <button class="btn" id="manageBtn" style="display: none;">
      <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M3 10h18"/></svg>
      Manage Subscription
    </button>
    <button class="btn danger" id="signOutBtn">
      <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Sign Out
    </button>
  </div>

  <!-- Privacy Notice -->
  <div class="privacy-notice">
    <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
    <p><strong>Your data is yours.</strong> Transcripts are encrypted on-device. We have zero access to your data. Audio is processed in real-time and never stored on our servers.</p>
  </div>

  <!-- Account Details -->
  <div class="section-divider">Account</div>
  <div class="account-row">
    <span class="account-row-label">Email</span>
    <span class="account-row-value" id="accountEmail">---</span>
  </div>
  <div class="account-row">
    <span class="account-row-label">Member since</span>
    <span class="account-row-value" id="accountCreated">---</span>
  </div>
  <div class="account-row" id="subscriptionRow" style="display: none;">
    <span class="account-row-label">Subscription</span>
    <span class="account-row-value" id="subscriptionStatus">---</span>
  </div>

</div>

<!-- ── Footer ── -->
<footer class="footer">
  <p>Write On &mdash; Voice to text, instantly</p>
</footer>

<script>
(function() {
  // ── Supabase init ──
  const SUPABASE_URL = 'https://oknhmmjpzkujiuhvwnuf.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rbmhtbWpwemt1aml1aHZ3bnVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyODIxOTksImV4cCI6MjA4Njg1ODE5OX0.mWu4uaUQTMS7jutA5_OBxU9H0GhKGRtcJ6Pc2nNWzCw';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const loadingState = document.getElementById('loadingState');
  const dashboardContent = document.getElementById('dashboardContent');

  // ── Check auth ──
  async function init() {
    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      window.location.href = '/login/';
      return;
    }

    await loadDashboard(session);
  }

  // ── Load dashboard data ──
  async function loadDashboard(session) {
    const user = session.user;

    // Set account info
    document.getElementById('accountEmail').textContent = user.email || '---';
    document.getElementById('welcomeText').textContent = 'Welcome back, ' + (user.email ? user.email.split('@')[0] : 'user') + '.';

    const createdAt = new Date(user.created_at);
    document.getElementById('accountCreated').textContent = createdAt.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    // Fetch user profile from Supabase
    let plan = 'free';
    let usageMinutes = 0;
    let limitMinutes = 15;
    let billingInterval = null;
    let stripeCustomerId = null;

    try {
      const { data: profile, error } = await supabase
        .from('profiles')
        .select('subscription, monthly_minutes_limit, stripe_customer_id, stripe_subscription_id, subscription_expires_at')
        .eq('id', user.id)
        .single();

      if (profile && !error) {
        plan = profile.subscription || 'free';
        limitMinutes = profile.monthly_minutes_limit || 15;
        stripeCustomerId = profile.stripe_customer_id || null;
      }
    } catch (err) {
      console.warn('Could not fetch profile:', err);
    }

    // Update plan display
    updatePlanUI(plan, usageMinutes, limitMinutes, billingInterval, stripeCustomerId);

    // Show dashboard
    loadingState.classList.add('hidden');
    dashboardContent.classList.remove('hidden');
  }

  function updatePlanUI(plan, usageMinutes, limitMinutes, billingInterval, stripeCustomerId) {
    const planName = document.getElementById('planName');
    const planBadge = document.getElementById('planBadge');
    const billingAmount = document.getElementById('billingAmount');
    const billingDetail = document.getElementById('billingDetail');
    const usageCount = document.getElementById('usageCount');
    const usageBar = document.getElementById('usageBar');
    const upgradeBtn = document.getElementById('upgradeBtn');
    const manageBtn = document.getElementById('manageBtn');
    const subscriptionRow = document.getElementById('subscriptionRow');
    const subscriptionStatus = document.getElementById('subscriptionStatus');

    // Set date labels
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    document.getElementById('usageStart').textContent = monthStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    document.getElementById('usageEnd').textContent = monthEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    if (plan === 'pro') {
      planName.textContent = 'Pro';
      planBadge.textContent = 'PRO';
      planBadge.className = 'plan-badge pro';

      if (billingInterval === 'annual') {
        billingAmount.innerHTML = '<span>$</span>48';
        billingDetail.textContent = 'per year ($4/month)';
      } else {
        billingAmount.innerHTML = '<span>$</span>5';
        billingDetail.textContent = 'per month';
      }

      usageCount.innerHTML = '<span>Unlimited</span>';
      usageBar.style.width = '100%';
      usageBar.classList.add('unlimited');

      upgradeBtn.style.display = 'none';
      manageBtn.style.display = 'inline-flex';
      subscriptionRow.style.display = 'flex';
      subscriptionStatus.textContent = 'Active';

    } else if (plan === 'lifetime') {
      planName.textContent = 'Lifetime';
      planBadge.textContent = 'LIFETIME';
      planBadge.className = 'plan-badge lifetime';

      billingAmount.innerHTML = '<span>$</span>79';
      billingDetail.textContent = 'one-time payment';

      usageCount.innerHTML = '<span>Unlimited</span>';
      usageBar.style.width = '100%';
      usageBar.classList.add('unlimited');

      upgradeBtn.style.display = 'none';
      manageBtn.style.display = 'none';
      subscriptionRow.style.display = 'flex';
      subscriptionStatus.textContent = 'Lifetime license';

    } else {
      // Free plan
      planName.textContent = 'Free';
      planBadge.textContent = 'FREE';
      planBadge.className = 'plan-badge free';

      billingAmount.innerHTML = '<span>$</span>0';
      billingDetail.textContent = 'No active subscription';

      const used = Math.round(usageMinutes * 10) / 10;
      usageCount.innerHTML = '<span>' + used + '</span> / ' + limitMinutes + ' min';

      const pct = Math.min(100, (usageMinutes / limitMinutes) * 100);
      usageBar.style.width = pct + '%';

      if (pct >= 80) {
        usageBar.classList.add('warning');
      }

      upgradeBtn.style.display = 'inline-flex';
      manageBtn.style.display = 'none';
    }

    // Manage subscription button (Stripe portal)
    if (stripeCustomerId) {
      manageBtn.addEventListener('click', async function() {
        manageBtn.textContent = 'Opening...';
        manageBtn.disabled = true;

        try {
          const { data, error } = await supabase.functions.invoke('create-portal-session', {
            body: { customerId: stripeCustomerId }
          });

          if (error) throw error;

          if (data && data.url) {
            window.location.href = data.url;
          } else {
            throw new Error('No portal URL returned');
          }
        } catch (err) {
          console.error('Portal error:', err);
          manageBtn.textContent = 'Manage Subscription';
          manageBtn.disabled = false;
          alert('Could not open subscription manager. Please try again.');
        }
      });
    }
  }

  // ── Sign Out ──
  document.getElementById('signOutBtn').addEventListener('click', async function() {
    const btn = this;
    btn.textContent = 'Signing out...';
    btn.disabled = true;

    try {
      await supabase.auth.signOut();
      window.location.href = '/';
    } catch (err) {
      console.error('Sign out error:', err);
      btn.textContent = 'Sign Out';
      btn.disabled = false;
    }
  });

  // ── Auth state change listener ──
  supabase.auth.onAuthStateChange(function(event, session) {
    if (event === 'SIGNED_OUT') {
      window.location.href = '/';
    }
  });

  init();
})();
</script>

</body>
</html>